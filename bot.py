# -*- coding: utf-8 -*-
"""bot.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1az9gUCkcs1yJhBlNlki7e965ewZ7XjR0
"""

import os
import requests
import asyncio
import datetime
import pytz
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command

# üîë –¢–æ–∫–µ–Ω—ã –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è
BOT_TOKEN = os.getenv("BOT_TOKEN")
YOUR_CHAT_ID = int(os.getenv("YOUR_CHAT_ID"))

# üîç –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, —Ä–µ–≥–∏–æ–Ω—ã –∏ —Å—Ç–∞—Ç—É—Å—ã
KEYWORDS = ["–∫–∞–±–µ–ª—å", "–ø—Ä–æ–≤–æ–¥", "–æ–ø—Ç–æ–≤–æ–ª–æ–∫–Ω–æ", "—Å–≤–µ—Ç"]
REGIONS = ["270000000", "310000000", "350000000"]  # –ó–ö–û, –ê—Ç—ã—Ä–∞—É, –ú–∞–Ω–≥—ã—Å—Ç–∞—É
STATUSES = ["PUBLISHED", "COMPLETED", "CANCELED"]

# API Samruk-Kazyna
BASE_URL = "https://ows.goszakup.gov.kz/v3/tender"

# –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ–Ω–¥–µ—Ä—ã
sent_tenders = set()

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# ‚ö° –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–Ω–¥–µ—Ä–æ–≤
def get_tenders(keyword, region, status):
    params = {
        "search_text": keyword,
        "customer_region": region,
        "purchase_status": status,
        "page": 1,
        "limit": 5
    }

    headers = {}
    API_KEY = os.getenv("API_KEY")  # üîë –≤–æ–∑—å–º–∏ –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –æ–Ω —É —Ç–µ–±—è –µ—Å—Ç—å)
    if API_KEY:
        headers["Authorization"] = f"Bearer {API_KEY}"

    r = requests.get(BASE_URL, params=params, headers=headers)

    print("‚û°Ô∏è –ó–∞–ø—Ä–æ—Å:", r.url)          # –ø–æ–ª–Ω—ã–π URL –∑–∞–ø—Ä–æ—Å–∞
    print("üî¢ –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞:", r.status_code)
    try:
        data = r.json()
        print("üì© –û—Ç–≤–µ—Ç:", data)
    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ JSON:", e)
        print("–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:", r.text)
        return []

    if r.status_code == 200:
        return data.get("items", [])
    return []


# üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤—ã—Ö —Ç–µ–Ω–¥–µ—Ä–æ–≤
async def send_new_tenders(chat_id):
    global sent_tenders
    for kw in KEYWORDS:
        for reg in REGIONS:
            for st in STATUSES:
                tenders = get_tenders(kw, reg, st)
                for t in tenders:
                    tid = t.get("id")
                    if tid not in sent_tenders:
                        sent_tenders.add(tid)
                        region_name = t.get("regionNameRu", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
                        text = f"""
üîî –ù–æ–≤—ã–π —Ç–µ–Ω–¥–µ—Ä –Ω–∞–π–¥–µ–Ω!
üìÑ {t.get('nameRu')}
üè¢ {t.get('customerNameRu')}
üåç –†–µ–≥–∏–æ–Ω: {region_name}
üìÖ –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {t.get('publishDate')}
üìé –°—Å—ã–ª–∫–∞: https://zakup.sk.kz/#/purchase/view/{tid}
"""
                        await bot.send_message(chat_id, text)

# üïí –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å —Å 06:00 –¥–æ 23:00 (Asia/Almaty)
async def scheduler(chat_id):
    tz = pytz.timezone("Asia/Almaty")
    while True:
        now = datetime.datetime.now(tz)
        if 6 <= now.hour < 23:   # –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å 6 —É—Ç—Ä–∞ –¥–æ 23:00
            await send_new_tenders(chat_id)
        await asyncio.sleep(3600)  # –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å

# üîò /start
@dp.message(Command("start"))
async def start_cmd(message: types.Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç üëã\n–Ø –±–æ—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–∫—É–ø–æ–∫ Samruk-Kazyna.\n"
                         "–ü—Ä–æ–≤–µ—Ä—è—é –∫–∞–∂–¥—ã–π —á–∞—Å —Å 06:00 –¥–æ 23:00 (Asia/Almaty).\n"
                         "–ò—Å–ø–æ–ª—å–∑—É–π /check –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.")

# üîò /check
@dp.message(Command("check"))
async def check_cmd(message: types.Message):
    await send_new_tenders(message.chat.id)
    await message.reply("‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!")

# üöÄ –ó–∞–ø—É—Å–∫
async def main():
    me = await bot.get_me()
    print(f"–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω: @{me.username}")
    asyncio.create_task(scheduler(YOUR_CHAT_ID))
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
